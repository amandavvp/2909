// =============================================================================
// Portal 2909 - Schema do Banco de Dados
// Prefeitura Municipal de Belford Roxo
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USUÁRIOS E AUTENTICAÇÃO
// =============================================================================
// Roles: CITIZEN, ATTENDANT, ANALYST, MANAGER, ADMIN (armazenado como String)

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  cpf           String    @unique
  phone         String?
  passwordHash  String
  role          String    @default("CITIZEN")
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  
  address       Address?  @relation("UserAddress")
  
  requests         ServiceRequest[] @relation("RequestAuthor")
  assignedRequests ServiceRequest[] @relation("RequestAssignee")
  comments         RequestComment[]
  auditLogs        AuditLog[]
  sessions         Session[]
  
  consentedAt    DateTime?
  consentVersion String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  @@index([email])
  @@index([cpf])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  userAgent String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model Address {
  id           String  @id @default(cuid())
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String  @default("Belford Roxo")
  state        String  @default("RJ")
  zipCode      String
  latitude     Float?
  longitude    Float?
  
  userId       String? @unique
  user         User?   @relation("UserAddress", fields: [userId], references: [id])
  
  requestId    String? @unique
  request      ServiceRequest? @relation("RequestAddress", fields: [requestId], references: [id])
  
  createdAt    DateTime @default(now())

  @@index([neighborhood])
  @@index([zipCode])
  @@map("addresses")
}

// =============================================================================
// CATEGORIAS E SERVIÇOS
// =============================================================================

model ServiceCategory {
  id            String      @id @default(cuid())
  name          String
  slug          String      @unique
  description   String?
  icon          String
  order         Int         @default(0)
  isActive      Boolean     @default(true)
  
  // Secretaria responsável por esta categoria
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  
  services      Service[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([slug])
  @@index([isActive])
  @@index([departmentId])
  @@map("service_categories")
}

model Service {
  id               String          @id @default(cuid())
  name             String
  slug             String
  description      String
  categoryId       String
  category         ServiceCategory @relation(fields: [categoryId], references: [id])
  
  detailedInfo     String?         // JSON string
  fields           String?         // JSON string
  
  slaHours         Int             @default(120)
  slaPriority      String          @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  
  requiresAuth     Boolean         @default(false)
  isActive         Boolean         @default(true)
  order            Int             @default(0)
  
  requests         ServiceRequest[]
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@unique([categoryId, slug])
  @@index([categoryId])
  @@index([isActive])
  @@map("services")
}

// =============================================================================
// SOLICITAÇÕES / PROTOCOLOS
// =============================================================================
// Status: PENDING, IN_PROGRESS, WAITING_INFO, FORWARDED, RESOLVED, CLOSED, CANCELLED, REOPENED
// Origin: PORTAL, APP, PHONE, IN_PERSON, WHATSAPP, EMAIL, IMPORT

model ServiceRequest {
  id            String    @id @default(cuid())
  protocol      String    @unique
  
  userId        String?
  user          User?     @relation("RequestAuthor", fields: [userId], references: [id])
  isAnonymous   Boolean   @default(false)
  
  serviceId     String
  service       Service   @relation(fields: [serviceId], references: [id])
  
  description   String
  status        String    @default("PENDING")
  origin        String    @default("PORTAL")
  
  address       Address?  @relation("RequestAddress")
  
  assigneeId    String?
  assignee      User?     @relation("RequestAssignee", fields: [assigneeId], references: [id])
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  
  slaDeadline   DateTime?
  slaBreached   Boolean   @default(false)
  
  rating        Int?
  ratingComment String?
  
  extraData     String?   // JSON string
  
  attachments   Attachment[]
  history       RequestHistory[]
  comments      RequestComment[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  resolvedAt    DateTime?
  closedAt      DateTime?

  @@index([protocol])
  @@index([userId])
  @@index([serviceId])
  @@index([status])
  @@index([assigneeId])
  @@index([departmentId])
  @@index([createdAt])
  @@index([slaDeadline])
  @@index([slaBreached])
  @@map("service_requests")
}

model RequestHistory {
  id          String    @id @default(cuid())
  requestId   String
  request     ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  fromStatus  String?
  toStatus    String
  message     String
  isPublic    Boolean   @default(true)
  
  userId      String?
  userName    String?
  
  createdAt   DateTime  @default(now())

  @@index([requestId])
  @@index([createdAt])
  @@map("request_history")
}

model RequestComment {
  id          String    @id @default(cuid())
  requestId   String
  request     ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  content     String
  isInternal  Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([requestId])
  @@index([userId])
  @@map("request_comments")
}

model Attachment {
  id          String    @id @default(cuid())
  requestId   String
  request     ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  fileName    String
  fileUrl     String
  fileType    String
  fileSize    Int
  uploadedBy  String?
  
  createdAt   DateTime  @default(now())

  @@index([requestId])
  @@map("attachments")
}

// =============================================================================
// SECRETARIAS MUNICIPAIS
// =============================================================================

model Department {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  email       String?
  phone       String?
  isActive    Boolean   @default(true)
  
  requests    ServiceRequest[]
  categories  ServiceCategory[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("departments")
}

// =============================================================================
// CONFIGURAÇÕES DO SISTEMA
// =============================================================================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  group     String   @default("general")
  label     String
  
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
  @@index([group])
  @@map("system_configs")
}

model InstitutionalContent {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  content   String
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@map("institutional_contents")
}

// =============================================================================
// NOTÍCIAS
// =============================================================================

model News {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  excerpt     String
  content     String
  image       String?
  category    String
  author      String
  isPublished Boolean   @default(false)
  
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@index([publishedAt])
  @@map("news")
}

// =============================================================================
// FAQ
// =============================================================================

model FAQ {
  id         String   @id @default(cuid())
  question   String
  answer     String
  categoryId String
  order      Int      @default(0)
  isActive   Boolean  @default(true)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([categoryId])
  @@index([isActive])
  @@map("faqs")
}

// =============================================================================
// AUDITORIA E LOGS (LGPD)
// =============================================================================
// Actions: CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, EXPORT, STATUS_CHANGE, ASSIGNMENT, COMMENT

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  action      String   // CREATE, READ, UPDATE, DELETE, LOGIN, etc.
  entity      String
  entityId    String?
  
  oldValues   String?  // JSON string
  newValues   String?  // JSON string
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// NOTIFICAÇÕES
// =============================================================================
// Types: STATUS_UPDATE, NEW_COMMENT, SLA_WARNING, SLA_BREACH, SYSTEM

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // STATUS_UPDATE, NEW_COMMENT, etc.
  title     String
  message   String
  data      String?  // JSON string
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}
